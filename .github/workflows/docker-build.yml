name: Optimized Build and Deploy

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ================= DETECT CHANGES =================
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      auth: ${{ steps.changes.outputs.auth }}
      user: ${{ steps.changes.outputs.user }}
      gateway: ${{ steps.changes.outputs.gateway }}
      shared: ${{ steps.changes.outputs.shared }}
      any-service: ${{ steps.changes.outputs.auth == 'true' || steps.changes.outputs.user == 'true' || steps.changes.outputs.gateway == 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            auth:
              - 'apps/auth/**'
              - 'libs/**'
              - 'package*.json'
            user:
              - 'apps/user/**'
              - 'libs/**'
              - 'package*.json'
            gateway:
              - 'apps/graphql-gateway/**'
              - 'libs/**'
              - 'package*.json'
            shared:
              - 'libs/**'
              - 'package*.json'
              - '.github/workflows/**'

  # ================= TEST CHANGED SERVICES =================
  test:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.any-service == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: [auth, user, gateway]
        include:
          - service: auth
            build-script: "build:auth"
          - service: user
            build-script: "build:user"
          - service: gateway
            build-script: "build:gateway"
    
    steps:
      - uses: actions/checkout@v4
        if: needs.detect-changes.outputs[matrix.service] == 'true'
      
      - uses: actions/setup-node@v4
        if: needs.detect-changes.outputs[matrix.service] == 'true'
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: needs.detect-changes.outputs[matrix.service] == 'true'
        run: npm ci

      - name: Lint ${{ matrix.service }}
        if: needs.detect-changes.outputs[matrix.service] == 'true'
        run: npm run lint:check

      - name: Test ${{ matrix.service }}
        if: needs.detect-changes.outputs[matrix.service] == 'true'
        run: npm run test

      - name: Build ${{ matrix.service }}
        if: needs.detect-changes.outputs[matrix.service] == 'true'
        run: npm run ${{ matrix.build-script }}

  # ================= DOCKER BUILD & PUSH =================
  docker:
    needs: [detect-changes, test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && needs.detect-changes.outputs.any-service == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: [auth, user, gateway]
        include:
          - service: auth
            dockerfile: apps/auth/Dockerfile
            image: foodfund-auth
          - service: user
            dockerfile: apps/user/Dockerfile
            image: foodfund-user
          - service: gateway
            dockerfile: apps/graphql-gateway/Dockerfile
            image: foodfund-graphql-gateway
    
    steps:
      - uses: actions/checkout@v4
        if: needs.detect-changes.outputs[matrix.service] == 'true'

      - uses: docker/setup-buildx-action@v3
        if: needs.detect-changes.outputs[matrix.service] == 'true'
        with:
          driver: docker-container
          install: true

      - uses: docker/login-action@v3
        if: needs.detect-changes.outputs[matrix.service] == 'true'
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set image tags
        if: needs.detect-changes.outputs[matrix.service] == 'true'
        run: |
          if [ "${GITHUB_REF##*/}" = "main" ]; then
            echo "TAG=latest" >> $GITHUB_ENV
          else
            echo "TAG=develop" >> $GITHUB_ENV
          fi

      - name: Build & Push ${{ matrix.service }} Service
        if: needs.detect-changes.outputs[matrix.service] == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.image }}:${{ env.TAG }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          platforms: linux/amd64

  # ================= BUILD SUMMARY =================
  build-summary:
    needs: [detect-changes, docker]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'push'
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Changed | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Auth | ${{ needs.detect-changes.outputs.auth }} | ${{ needs.detect-changes.outputs.auth == 'true' && 'âœ… Built' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| User | ${{ needs.detect-changes.outputs.user }} | ${{ needs.detect-changes.outputs.user == 'true' && 'âœ… Built' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gateway | ${{ needs.detect-changes.outputs.gateway }} | ${{ needs.detect-changes.outputs.gateway == 'true' && 'âœ… Built' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY

  # ================= DEPLOY =================
  deploy:
    needs: [detect-changes, docker]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && needs.detect-changes.outputs.any-service == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install doctl
        run: |
          curl -sL https://github.com/digitalocean/doctl/releases/download/v1.117.0/doctl-1.117.0-linux-amd64.tar.gz \
          | tar -xzv
          sudo mv doctl /usr/local/bin

      - name: Authenticate doctl
        run: doctl auth init -t ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Sync secrets to DO App
        run: |
          doctl apps update ${{ secrets.DOCTL_APP_ID }} \
            --set-env KEY=USERS_DATABASE_URL,scope=RUN_TIME,type=SECRET,value=${{ secrets.USERS_DATABASE_URL }} \
            --set-env KEY=AWS_REGION,scope=RUN_TIME,type=SECRET,value=${{ secrets.AWS_REGION }} \
            --set-env KEY=AWS_COGNITO_USER_POOL_ID,scope=RUN_TIME,type=SECRET,value=${{ secrets.AWS_COGNITO_USER_POOL_ID }} \
            --set-env KEY=AWS_COGNITO_CLIENT_ID,scope=RUN_TIME,type=SECRET,value=${{ secrets.AWS_COGNITO_CLIENT_ID }} \
            --set-env KEY=AWS_ACCESS_KEY_ID,scope=RUN_TIME,type=SECRET,value=${{ secrets.AWS_ACCESS_KEY_ID }} \
            --set-env KEY=AWS_SECRET_ACCESS_KEY,scope=RUN_TIME,type=SECRET,value=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
            --set-env KEY=AWS_COGNITO_CLIENT_SECRET,scope=RUN_TIME,type=SECRET,value=${{ secrets.AWS_COGNITO_CLIENT_SECRET }}

      - name: Deploy to DigitalOcean App Platform
        env:
          DOCTL_APP_ID: ${{ secrets.DOCTL_APP_ID }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          # Replace registry placeholders in .do/app-spec.yaml with actual image names
          sed -i "s|ttrece/foodfund-auth|${DOCKERHUB_USERNAME}/foodfund-auth|g" .do/app-spec.yaml
          sed -i "s|ttrece/foodfund-user|${DOCKERHUB_USERNAME}/foodfund-user|g" .do/app-spec.yaml
          sed -i "s|ttrece/foodfund-graphql-gateway|${DOCKERHUB_USERNAME}/foodfund-graphql-gateway|g" .do/app-spec.yaml
          
          echo "Using develop tag to override existing images"

          # Trigger new deployment with updated spec
          doctl apps create-deployment $DOCTL_APP_ID --spec .do/app-spec.yaml

