name: FoodFund CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      - run: npm run lint
      - run: npm run test
      - run: npm run build auth
      - run: npm run build user
      - run: npm run build graphql-gateway

  docker:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - uses: docker/setup-buildx-action@v3
      
      - name: Set tag
        run: echo "TAG=${GITHUB_REF##*/}" >> $GITHUB_ENV
      
      - name: Build & Push Images
        run: |
          # Build and push all services in parallel
          docker buildx build -t ${{ secrets.DOCKERHUB_USERNAME }}/foodfund-auth:$TAG \
            -f apps/auth/Dockerfile . --push &
          
          docker buildx build -t ${{ secrets.DOCKERHUB_USERNAME }}/foodfund-user:$TAG \
            -f apps/user/Dockerfile . --push &
          
          docker buildx build -t ${{ secrets.DOCKERHUB_USERNAME }}/foodfund-graphql-gateway:$TAG \
            -f apps/graphql-gateway/Dockerfile . --push &
          
          wait  # Wait for all builds to complete

  deploy:
    needs: docker
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      
      - name: Setup kubectl
        run: doctl kubernetes cluster kubeconfig save ${{ secrets.DIGITALOCEAN_CLUSTER_NAME }}
      
      - name: Setup kubectl
        run: |
          echo "kubectl configured"
      
      - name: Set environment
        run: |
          if [ "${GITHUB_REF##*/}" = "main" ]; then
            echo "NAMESPACE=foodfund-production" >> $GITHUB_ENV
            echo "REPLICAS=2" >> $GITHUB_ENV
          else
            echo "NAMESPACE=foodfund-staging" >> $GITHUB_ENV  
            echo "REPLICAS=1" >> $GITHUB_ENV
          fi
          echo "TAG=${GITHUB_REF##*/}" >> $GITHUB_ENV
      
      - name: Deploy (apply manifests)
        shell: pwsh
        env:
          DATABASE_HOST: ${{ secrets.DATABASE_HOST }}
          DATABASE_PORT: ${{ secrets.DATABASE_PORT }}
          DATABASE_USERNAME: ${{ secrets.DATABASE_USERNAME }}
          DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
          DATABASE_SSL_MODE: ${{ secrets.DATABASE_SSL_MODE || 'require' }}
          # Provide DigitalOcean token+cluster so apply.ps1 can fetch kubeconfig when needed
          DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          DIGITALOCEAN_CLUSTER_NAME: ${{ secrets.DIGITALOCEAN_CLUSTER_NAME }}
          AUTH_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/foodfund-auth:${{ github.ref_name }}
          USER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/foodfund-user:${{ github.ref_name }}
          GATEWAY_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/foodfund-graphql-gateway:${{ github.ref_name }}
        run: |
          # Run the apply script (PowerShell) to create the secret and apply manifests
          pwsh -NoProfile -NonInteractive -Command "./k8s/apply.ps1 -namespace $env:NAMESPACE"
          # Wait a few seconds for pods to be created
          Start-Sleep -Seconds 15
      
      - name: Get Status
        run: |
          echo "üéâ Deployment completed!"
          kubectl get pods -n $NAMESPACE
          kubectl get svc -n $NAMESPACE
          
          # Get LoadBalancer IP (linux shell substitute)
          EXTERNAL_IP=$(kubectl get svc -n $NAMESPACE -o jsonpath='{.items[?(@.spec.type=="LoadBalancer")].status.loadBalancer.ingress[0].ip}' || echo "pending")
          if [ "$EXTERNAL_IP" != "pending" ] && [ -n "$EXTERNAL_IP" ]; then
            echo "üåê App URL: http://$EXTERNAL_IP"
            echo "üéØ GraphQL: http://$EXTERNAL_IP/graphql" 
          else
            echo "‚è≥ LoadBalancer IP pending. Check: kubectl get svc -n $NAMESPACE"
          fi