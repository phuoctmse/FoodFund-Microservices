name: FoodFund CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      - run: npm run lint
      - run: npm run test
      - run: npm run build auth
      - run: npm run build user
      - run: npm run build graphql-gateway

  docker:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - uses: docker/setup-buildx-action@v3
      
      - name: Set tag
        run: echo "TAG=${GITHUB_REF##*/}" >> $GITHUB_ENV
      
      - name: Build & Push Images
        run: |
          # Build and push all services in parallel
          docker buildx build -t ${{ secrets.DOCKERHUB_USERNAME }}/foodfund-auth:$TAG \
            -f apps/auth/Dockerfile . --push &
          
          docker buildx build -t ${{ secrets.DOCKERHUB_USERNAME }}/foodfund-user:$TAG \
            -f apps/user/Dockerfile . --push &
          
          docker buildx build -t ${{ secrets.DOCKERHUB_USERNAME }}/foodfund-graphql-gateway:$TAG \
            -f apps/graphql-gateway/Dockerfile . --push &
          
          wait  # Wait for all builds to complete

  deploy:
    needs: docker
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      
      - name: Setup kubectl
        run: doctl kubernetes cluster kubeconfig save ${{ secrets.DIGITALOCEAN_CLUSTER_NAME }}
      
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'
      
      - name: Set environment
        run: |
          if [ "${GITHUB_REF##*/}" = "main" ]; then
            echo "NAMESPACE=foodfund-production" >> $GITHUB_ENV
            echo "REPLICAS=2" >> $GITHUB_ENV
          else
            echo "NAMESPACE=foodfund-staging" >> $GITHUB_ENV  
            echo "REPLICAS=1" >> $GITHUB_ENV
          fi
          echo "TAG=${GITHUB_REF##*/}" >> $GITHUB_ENV
      
      - name: Deploy
        run: |
          # Create namespace
          kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
          
          # Clean up any existing release (use fixed release name per environment)
          helm uninstall foodfund -n $NAMESPACE || true
          
          # Test template rendering first
          echo "üß™ Testing template rendering..."
          helm template foodfund-$TAG ./k8s \
            --set-string externalDatabase.host="${{ secrets.DATABASE_HOST }}" \
            --set-string externalDatabase.username="${{ secrets.DATABASE_USERNAME }}" \
            --set-string externalDatabase.password="${{ secrets.DATABASE_PASSWORD }}" \
            --set-string externalDatabase.port="${{ secrets.DATABASE_PORT }}" \
            --set namespace.create=false > /dev/null
          echo "‚úÖ Templates are valid"
          
          # Deploy with complete configuration (without --wait for faster deployment)
          helm upgrade --install foodfund ./k8s \
            --namespace $NAMESPACE \
            --set global.imageRegistry=${{ secrets.DOCKERHUB_USERNAME }} \
            --set namespace.create=false \
            --set auth.image.tag=$TAG \
            --set user.image.tag=$TAG \
            --set gateway.image.tag=$TAG \
            --set auth.replicaCount=$REPLICAS \
            --set user.replicaCount=$REPLICAS \
            --set gateway.replicaCount=$REPLICAS \
            --set-string externalDatabase.host="${{ secrets.DATABASE_HOST }}" \
            --set-string externalDatabase.port="${{ secrets.DATABASE_PORT }}" \
            --set-string externalDatabase.username="${{ secrets.DATABASE_USERNAME }}" \
            --set-string externalDatabase.password="${{ secrets.DATABASE_PASSWORD }}" \
            --set aws.region=${{ secrets.AWS_REGION || 'us-east-1' }} \
            --set aws.cognito.userPoolId=${{ secrets.AWS_COGNITO_USER_POOL_ID || 'mock-user-pool-id' }} \
            --set aws.cognito.clientId=${{ secrets.AWS_COGNITO_CLIENT_ID || 'mock-client-id' }} \
            --set aws.cognito.clientSecret=${{ secrets.AWS_COGNITO_CLIENT_SECRET || '' }} \
            --set aws.accessKeyId=${{ secrets.AWS_ACCESS_KEY_ID || '' }} \
            --set aws.secretAccessKey=${{ secrets.AWS_SECRET_ACCESS_KEY || '' }} \
            --timeout 5m
          
          # Give pods time to start
          echo "‚è≥ Waiting for pods to start..."
          sleep 30
      
      - name: Get Status
        run: |
          echo "üéâ Deployment completed!"
          kubectl get pods -n $NAMESPACE
          kubectl get svc -n $NAMESPACE
          
          # Get LoadBalancer IP
          EXTERNAL_IP=$(kubectl get svc -n $NAMESPACE -o jsonpath='{.items[?(@.spec.type=="LoadBalancer")].status.loadBalancer.ingress[0].ip}' || echo "pending")
          
          if [ "$EXTERNAL_IP" != "pending" ] && [ -n "$EXTERNAL_IP" ]; then
            echo "üåê App URL: http://$EXTERNAL_IP"
            echo "üéØ GraphQL: http://$EXTERNAL_IP/graphql" 
          else
            echo "‚è≥ LoadBalancer IP pending. Check: kubectl get svc -n $NAMESPACE"
          fi