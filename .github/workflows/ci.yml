name: FoodFund CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # --- CI (lint + test) ---
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run lint
      - run: npm run test

  # --- Build Docker images (chỉ build nếu có thay đổi) ---
  docker-auth:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            src:
              - 'apps/auth/**'
      - if: steps.changes.outputs.src == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - if: steps.changes.outputs.src == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/auth/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/foodfund-auth:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/foodfund-auth:cache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/foodfund-auth:cache,mode=max

  docker-user:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            src:
              - 'apps/user/**'
      - if: steps.changes.outputs.src == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - if: steps.changes.outputs.src == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/user/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/foodfund-user:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/foodfund-user:cache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/foodfund-user:cache,mode=max

  docker-gateway:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            src:
              - 'apps/graphql-gateway/**'
      - if: steps.changes.outputs.src == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - if: steps.changes.outputs.src == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/graphql-gateway/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/foodfund-graphql-gateway:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/foodfund-graphql-gateway:cache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/foodfund-graphql-gateway:cache,mode=max

  # --- Deploy ---
  deploy:
    needs: [docker-auth, docker-user, docker-gateway]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Setup kubeconfig
        run: doctl kubernetes cluster kubeconfig save ${{ secrets.DIGITALOCEAN_CLUSTER_ID }}

      - uses: azure/setup-helm@v4
        with:
          version: v3.15.2

      - name: Set deploy env
        run: |
          if [ "${GITHUB_REF##*/}" = "main" ]; then
            echo "NAMESPACE=foodfund-production" >> $GITHUB_ENV
            echo "REPLICAS=2" >> $GITHUB_ENV
          else
            echo "NAMESPACE=foodfund-staging" >> $GITHUB_ENV
            echo "REPLICAS=1" >> $GITHUB_ENV
          fi
          echo "TAG=${GITHUB_SHA}" >> $GITHUB_ENV

      - name: Deploy with Helm
        run: |
          set -euo pipefail
          for svc in auth user graphql-gateway; do
            repo="${{ secrets.DOCKERHUB_USERNAME }}/foodfund-$svc"
            chart="k8s/$svc"
            release="foodfund-$svc"

            echo "Deploying $release with image $repo:$TAG"
            if ! helm upgrade --install "$release" "$chart" \
              --namespace "$NAMESPACE" --create-namespace \
              --set image.repository="$repo" \
              --set image.tag="$TAG" \
              --set replicaCount="$REPLICAS" \
              --wait --timeout=2m --atomic; then
              
              echo "--- Helm failed for $release, debugging ---"
              kubectl get pods -n "$NAMESPACE" -o wide || true
              kubectl describe deployment "$release" -n "$NAMESPACE" || true
              for p in $(kubectl get pods -n "$NAMESPACE" -l app=$release -o name || true); do
                echo "--- Logs for $p ---"
                kubectl logs "$p" -n "$NAMESPACE" --tail=50 || true
              done
              exit 1
            fi
          done

      - name: Show cluster status
        run: |
          kubectl get pods -n $NAMESPACE
          kubectl get svc -n $NAMESPACE
