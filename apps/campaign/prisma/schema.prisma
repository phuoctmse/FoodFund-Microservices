generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/campaign-client"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("CAMPAIGN_DATABASE_URL")
}

model Campaign {
  id                           String          @id @default(uuid())
  title                        String          @db.Text()
  description                  String          @db.Text()
  cover_image                  String          @db.Text()
  cover_image_file_key         String?         @db.Text()
  target_amount                BigInt          @default(0)
  received_amount              BigInt          @default(0)
  donation_count               Int             @default(0)
  status                       Campaign_Status @default(PENDING)
  fundraising_start_date       DateTime
  fundraising_end_date         DateTime
  ingredient_budget_percentage Decimal         @db.Decimal(5, 2)
  cooking_budget_percentage    Decimal         @db.Decimal(5, 2)
  delivery_budget_percentage   Decimal         @db.Decimal(5, 2)
  extension_count              Int             @default(0)
  extension_days               Int             @default(0)
  is_active                    Boolean         @default(true)
  created_by                   String
  category_id                  String?
  changed_status_at            DateTime?
  completed_at                 DateTime?
  created_at                   DateTime        @default(now())
  updated_at                   DateTime        @updatedAt

  donations       Donation[]
  category        Campaign_Category? @relation(fields: [category_id], references: [id], onDelete: SetNull)
  posts           Post[]
  campaign_phases Campaign_Phase[]

  @@index([status])
  @@index([created_by])
  @@index([created_at])
  @@index([fundraising_start_date, fundraising_end_date])
  @@index([changed_status_at])
  @@index([status, changed_status_at])
  @@index([category_id])
  @@index([status, fundraising_end_date])
  @@index([donation_count])
  @@map("campaigns")
}

model Campaign_Phase {
  id                       String                @id @default(uuid())
  campaign_id              String
  phase_name               String                @db.VarChar(100)
  location                 String                @db.Text()
  ingredient_purchase_date DateTime
  cooking_date             DateTime
  delivery_date            DateTime
  status                   Campaign_Phase_Status @default(PLANNING)
  is_active                Boolean               @default(true)
  created_at               DateTime              @default(now())
  updated_at               DateTime              @updatedAt

  campaign Campaign @relation(fields: [campaign_id], references: [id], onDelete: Cascade)

  @@index([campaign_id])
  @@index([status])
  @@index([created_at])
  @@index([campaign_id, status])
  @@index([ingredient_purchase_date])
  @@index([cooking_date])
  @@index([delivery_date])
  @@map("campaign_phases")
}

model Campaign_Category {
  id          String   @id @default(uuid())
  title       String   @db.VarChar(100)
  description String   @db.Text()
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  campaigns Campaign[]

  @@index([is_active])
  @@index([title])
  @@map("campaign_categories")
}

model Donation {
  id           String   @id @default(uuid())
  donor_id     String
  donor_name   String?
  campaign_id  String
  amount       BigInt   @default(0)
  is_anonymous Boolean  @default(false)
  created_at   DateTime @default(now())

  campaign             Campaign              @relation(fields: [campaign_id], references: [id], onDelete: Cascade)
  payment_transactions Payment_Transaction[]

  @@index([campaign_id])
  @@index([donor_id])
  @@index([created_at])
  @@index([campaign_id, created_at])
  @@map("donations")
}

model Payment_Transaction {
  id          String         @id @default(uuid())
  donation_id String
  order_code  BigInt?        @unique
  amount      BigInt         @default(0)
  description String?        @db.Text()
  status      Payment_Status @default(PENDING)
  currency    String         @default("VND") @db.VarChar(10)

  // Gateway tracking
  gateway              String? @db.VarChar(50) // "PAYOS" or "SEPAY"
  processed_by_webhook Boolean @default(false) // Prevent duplicate processing

  // PayOS payment link info
  checkout_url              String?   @db.Text()
  qr_code                   String?   @db.Text()
  payment_link_id           String?   @db.VarChar(255)
  counter_account_bank_id   String?   @db.VarChar(50)
  counter_account_bank_name String?   @db.VarChar(255)
  counter_account_name      String?   @db.VarChar(255)
  counter_account_number    String?   @db.VarChar(50)
  virtual_account_name      String?   @db.VarChar(255)
  virtual_account_number    String?   @db.VarChar(50)
  reference                 String?   @db.VarChar(255)
  transaction_datetime      DateTime? @db.Timestamp()

  // Sepay webhook tracking (for reference only - Sepay transactions go to Admin Wallet)
  sepay_reference_number String? @db.VarChar(255) // Bank reference code (MBVCB.xxx)
  sepay_transaction_id   Int? // Sepay webhook payload ID
  is_matched             Boolean @default(false) // Did payment match donation?

  error_code        String? @db.VarChar(50)
  error_description String? @db.Text()

  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  refunded_at DateTime?

  donation Donation @relation(fields: [donation_id], references: [id], onDelete: Cascade)

  @@index([donation_id])
  @@index([status])
  @@index([created_at])
  @@index([order_code])
  @@index([payment_link_id])
  @@index([reference])
  @@index([gateway])
  @@index([processed_by_webhook])
  @@index([sepay_transaction_id])
  @@index([is_matched])
  @@index([status, gateway])
  @@map("payment_transactions")
}

model Post {
  id            String   @id @default(uuid())
  campaign_id   String
  created_by    String
  title         String   @db.VarChar(255)
  content       String   @db.Text()
  media         Json?
  like_count    Int      @default(0)
  comment_count Int      @default(0)
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  campaign Campaign       @relation(fields: [campaign_id], references: [id], onDelete: Cascade)
  likes    Post_Like[]
  comments Post_Comment[]

  @@index([campaign_id])
  @@index([created_by])
  @@index([is_active])
  @@index([created_at])
  @@index([campaign_id, is_active, created_at])
  @@index([like_count])
  @@map("posts")
}

model Post_Like {
  id         String   @id @default(uuid())
  post_id    String
  user_id    String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  post Post @relation(fields: [post_id], references: [id], onDelete: Cascade)

  @@unique([post_id, user_id])
  @@index([post_id])
  @@index([user_id])
  @@index([created_at])
  @@index([post_id, created_at])
  @@map("post_likes")
}

model Post_Comment {
  id                String   @id @default(uuid())
  post_id           String
  user_id           String
  content           String   @db.Text()
  parent_comment_id String?
  comment_path      String?  @db.Text()
  depth             Int      @default(0)
  is_active         Boolean  @default(true)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  post           Post           @relation(fields: [post_id], references: [id], onDelete: Cascade)
  parent_comment Post_Comment?  @relation("CommentReplies", fields: [parent_comment_id], references: [id], onDelete: Cascade)
  replies        Post_Comment[] @relation("CommentReplies")

  @@index([post_id])
  @@index([user_id])
  @@index([parent_comment_id])
  @@index([created_at])
  @@index([post_id, parent_comment_id, created_at])
  @@index([comment_path])
  @@index([depth])
  @@index([is_active])
  @@index([post_id, is_active, created_at])
  @@map("post_comments")
}

enum Campaign_Status {
  PENDING
  APPROVED
  REJECTED
  ACTIVE
  PROCESSING
  COMPLETED
  CANCELLED
}

enum Campaign_Phase_Status {
  PLANNING
  AWAITING_INGREDIENT_DISBURSEMENT
  INGREDIENT_PURCHASE
  AWAITING_AUDIT
  AWAITING_COOKING_DISBURSEMENT
  COOKING
  AWAITING_DELIVERY_DISBURSEMENT
  DELIVERY
  COMPLETED
  CANCELLED
  FAILED
}

enum Payment_Status {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}
